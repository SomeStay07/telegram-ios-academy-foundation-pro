name: API Fuzz Testing

on:
  push:
    branches: [ develop, main ]
    paths: [ 'apps/api/**' ]
  pull_request:
    branches: [ develop, main ]
    paths: [ 'apps/api/**' ]

jobs:
  schemathesis-fuzz:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          
      - name: Install Schemathesis
        run: pip install schemathesis
        
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9
          
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
        
      - name: Build API
        run: pnpm --filter @telegram-ios-academy/api build
        
      - name: Generate OpenAPI spec
        run: |
          cd apps/api
          pnpm start &
          sleep 10
          curl -o openapi-spec.json http://localhost:3000/api/docs-json
          pkill -f "pnpm start"
          
      - name: Run Schemathesis Fuzz Tests
        run: |
          cd apps/api
          # Start API server in background
          pnpm start &
          API_PID=$!
          sleep 10
          
          # Run Schemathesis fuzz tests
          schemathesis run \
            --base-url http://localhost:3000 \
            --checks all \
            --hypothesis-max-examples 50 \
            --hypothesis-phases explicit,reuse,generate,target,shrink \
            --validate-schema \
            --show-trace \
            --junit-xml schemathesis-report.xml \
            openapi-spec.json || true
          
          # Stop API server
          kill $API_PID
          
      - name: Upload Schemathesis Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: schemathesis-results
          path: |
            apps/api/schemathesis-report.xml
            apps/api/openapi-spec.json