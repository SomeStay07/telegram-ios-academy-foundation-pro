<!doctype html>
<html lang='ru'>
<head>
  <meta charset='UTF-8'/>
  
  <!-- Comprehensive Viewport Configuration -->
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=0.5, user-scalable=yes, viewport-fit=cover'/>
  
  <!-- PWA Meta Tags -->
  <meta name='mobile-web-app-capable' content='yes'/>
  <meta name='apple-mobile-web-app-capable' content='yes'/>
  <meta name='apple-mobile-web-app-status-bar-style' content='black-translucent'/>
  <meta name='theme-color' content='#000000'/>
  <meta name='msapplication-navbutton-color' content='#000000'/>
  
  <!-- Telegram WebApp Meta -->
  <meta name='telegram-web-app' content='1'/>
  
  <!-- Telegram WebApp Script - CRITICAL for WebApp API -->
  <script 
    src="https://telegram.org/js/telegram-web-app.js"
    onload="console.log('✅ Telegram script loaded successfully')"
    onerror="console.error('❌ Failed to load Telegram script from telegram.org')"
    crossorigin="anonymous"
  ></script>
  
  <!-- Visual Debug Panel for Telegram WebApp -->
  <script>
    // Create debug panel on screen
    function createDebugPanel() {
      const panel = document.createElement('div')
      panel.id = 'telegram-debug-panel'
      panel.style.cssText = `
        position: fixed;
        top: 10px;
        left: 10px;
        right: 10px;
        background: rgba(0, 0, 0, 0.9);
        color: #00ff00;
        font-family: monospace;
        font-size: 12px;
        padding: 10px;
        z-index: 9999;
        border: 2px solid #00ff00;
        border-radius: 8px;
        max-height: 300px;
        overflow-y: auto;
        white-space: pre-wrap;
      `
      document.body.appendChild(panel)
      return panel
    }

    // Add log to panel and console
    function debugLog(message, data = null) {
      console.log(message, data)
      const panel = document.getElementById('telegram-debug-panel') || createDebugPanel()
      const timestamp = new Date().toLocaleTimeString()
      panel.textContent += `[${timestamp}] ${message}\n`
      if (data) {
        panel.textContent += `${JSON.stringify(data, null, 2)}\n`
      }
      panel.textContent += '\n'
      panel.scrollTop = panel.scrollHeight
    }

    // Send debug data to our server
    function sendDebugToServer(debugData) {
      try {
        fetch('/debug-telegram', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(debugData)
        }).catch(err => debugLog('Failed to send debug data:', err.message))
      } catch (err) {
        debugLog('Error sending debug data:', err.message)
      }
    }

    // EMERGENCY DEBUG: Show all Telegram data immediately
    function emergencyTelegramDiagnostics() {
      const debugData = {
        timestamp: new Date().toISOString(),
        url: window.location.href,
        userAgent: navigator.userAgent,
        referrer: document.referrer,
        telegram: null,
        webApp: null,
        user: null,
        errors: []
      }

      debugLog('🚨 EMERGENCY TELEGRAM DIAGNOSTICS 🚨')
      debugLog('URL: ' + window.location.href)
      debugLog('User Agent: ' + navigator.userAgent)
      debugLog('Referrer: ' + document.referrer)
      
      // Check if Telegram object exists
      if (window.Telegram) {
        debugLog('✅ window.Telegram EXISTS')
        debugData.telegram = 'exists'
        
        if (window.Telegram.WebApp) {
          const webApp = window.Telegram.WebApp
          debugLog('✅ window.Telegram.WebApp EXISTS')
          
          // Collect WebApp data safely
          try {
            debugData.webApp = {
              keys: Object.keys(webApp),
              initData: webApp.initData || 'empty',
              initDataLength: webApp.initData?.length || 0,
              initDataUnsafe: webApp.initDataUnsafe || 'empty',
              platform: webApp.platform || 'unknown',
              version: webApp.version || 'unknown',
              isExpanded: webApp.isExpanded,
              colorScheme: webApp.colorScheme
            }
            
            debugLog('📱 WebApp Keys: ' + Object.keys(webApp).join(', '))
            debugLog('🔑 initData length: ' + (webApp.initData?.length || 0))
            debugLog('🔑 platform: ' + (webApp.platform || 'unknown'))
            debugLog('🔑 version: ' + (webApp.version || 'unknown'))
            
            if (webApp.initDataUnsafe?.user) {
              debugData.user = webApp.initDataUnsafe.user
              debugLog('👤 USER DATA FOUND:', webApp.initDataUnsafe.user)
            } else {
              debugLog('❌ NO USER DATA IN initDataUnsafe')
              debugData.user = 'missing'
            }
            
            // Try to initialize
            try {
              webApp.ready()
              webApp.expand()
              debugLog('✅ WebApp initialized successfully')
            } catch (error) {
              debugLog('❌ WebApp initialization failed: ' + error.message)
              debugData.errors.push('init_failed: ' + error.message)
            }
            
          } catch (error) {
            debugLog('❌ Error accessing WebApp properties: ' + error.message)
            debugData.errors.push('webapp_access_error: ' + error.message)
          }
          
        } else {
          debugLog('❌ window.Telegram.WebApp MISSING')
          debugData.webApp = 'missing'
        }
      } else {
        debugLog('❌ window.Telegram MISSING - NOT IN TELEGRAM')
        debugData.telegram = 'missing'
      }
      
      // Check query parameters for debug
      const urlParams = new URLSearchParams(window.location.search)
      const params = Object.fromEntries(urlParams)
      debugData.urlParams = params
      debugLog('🔍 URL Parameters:', params)

      // Send to server for debugging
      sendDebugToServer(debugData)
      
      debugLog('📤 Debug data sent to server for analysis')
    }
    
    // Run diagnostics immediately
    emergencyTelegramDiagnostics()
    
    // Run again after script loads
    setTimeout(emergencyTelegramDiagnostics, 500)
    setTimeout(emergencyTelegramDiagnostics, 1000)
    setTimeout(emergencyTelegramDiagnostics, 2000)
    
    // Also on DOMContentLoaded
    document.addEventListener('DOMContentLoaded', emergencyTelegramDiagnostics)

    // Add copy to clipboard functionality
    document.addEventListener('DOMContentLoaded', () => {
      setTimeout(() => {
        const panel = document.getElementById('telegram-debug-panel')
        if (panel) {
          const copyBtn = document.createElement('button')
          copyBtn.textContent = 'Copy Debug Info'
          copyBtn.style.cssText = `
            position: absolute;
            top: 5px;
            right: 5px;
            background: #00ff00;
            color: black;
            border: none;
            padding: 5px 10px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 10px;
          `
          copyBtn.onclick = () => {
            navigator.clipboard.writeText(panel.textContent).then(() => {
              copyBtn.textContent = 'Copied!'
              setTimeout(() => copyBtn.textContent = 'Copy Debug Info', 2000)
            })
          }
          panel.appendChild(copyBtn)
        }
      }, 3000)
    })
  </script>
  
  <title>iOS Academy Pro</title>
  <style>
    /* Telegram theme defaults for local development */
    :root {
      --tg-theme-bg-color: #0b0d10;
      --tg-theme-text-color: #e6e7e9;
      --tg-theme-button-color: #3b82f6;
      --tg-theme-button-text-color: #ffffff;
      --tg-theme-link-color: #60a5fa;
      --tg-color-scheme: dark;
      
      /* Design system fallbacks */
      --background: var(--tg-theme-bg-color);
      --foreground: var(--tg-theme-text-color);
      --primary: var(--tg-theme-button-color);
      --accent: var(--tg-theme-link-color);
    }
    
    /* Prevent white flash by applying Telegram theme immediately */
    html { 
      background: var(--tg-theme-bg-color, #000); 
      color-scheme: var(--tg-color-scheme, dark); 
    }
    body { 
      background: inherit; 
      margin: 0;
    }
  </style>
</head>
<body>
  <div id='root'></div>
  <script type='module' src='/src/main.tsx'></script>
</body>
</html>
