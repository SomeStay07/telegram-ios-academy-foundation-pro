<!doctype html>
<html lang='ru'>
<head>
  <meta charset='UTF-8'/>
  
  <!-- Comprehensive Viewport Configuration -->
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=0.5, user-scalable=yes, viewport-fit=cover'/>
  
  <!-- PWA Meta Tags -->
  <meta name='mobile-web-app-capable' content='yes'/>
  <meta name='apple-mobile-web-app-capable' content='yes'/>
  <meta name='apple-mobile-web-app-status-bar-style' content='black-translucent'/>
  <meta name='theme-color' content='#000000'/>
  <meta name='msapplication-navbutton-color' content='#000000'/>
  
  <!-- Telegram WebApp Meta -->
  <meta name='telegram-web-app' content='1'/>
  
  <!-- Telegram WebApp Script - CRITICAL for WebApp API -->
  <script 
    src="https://telegram.org/js/telegram-web-app.js"
    onload="console.log('‚úÖ Telegram script loaded successfully')"
    onerror="console.error('‚ùå Failed to load Telegram script from telegram.org')"
    crossorigin="anonymous"
  ></script>
  
  <!-- Enhanced Telegram WebApp Integration -->
  <script>
    // Wait for Telegram WebApp to load and initialize
    function initializeTelegramWebApp() {
      return new Promise((resolve) => {
        // Check multiple times for Telegram WebApp availability
        let attempts = 0
        const maxAttempts = 10
        
        const checkTelegram = () => {
          attempts++
          console.log(`üîç Checking for Telegram WebApp (attempt ${attempts})`)
          
          if (window.Telegram?.WebApp) {
            console.log('‚úÖ Telegram WebApp found!')
            const webApp = window.Telegram.WebApp
            
            // Initialize WebApp
            webApp.ready()
            webApp.expand()
            
            console.log('üì± Telegram WebApp Data:', {
              initData: webApp.initData,
              initDataUnsafe: webApp.initDataUnsafe,
              user: webApp.initDataUnsafe?.user,
              platform: webApp.platform,
              version: webApp.version,
              colorScheme: webApp.colorScheme
            })
            
            resolve(webApp)
          } else if (attempts < maxAttempts) {
            setTimeout(checkTelegram, 500)
          } else {
            console.log('‚ùå Telegram WebApp not available after multiple attempts')
            console.log('üîç Available window properties:', Object.keys(window).filter(k => k.toLowerCase().includes('telegram')))
            resolve(null)
          }
        }
        
        checkTelegram()
      })
    }
    
    // Initialize when DOM is ready
    document.addEventListener('DOMContentLoaded', initializeTelegramWebApp)
  </script>
  
  <!-- Fallback Script Loader -->
  <script>
    // Alternative script loading if first one fails
    function loadTelegramScript() {
      return new Promise((resolve, reject) => {
        if (window.Telegram) {
          console.log('üîç Telegram already available')
          resolve()
          return
        }
        
        const script = document.createElement('script')
        script.src = 'https://telegram.org/js/telegram-web-app.js'
        script.onload = () => {
          console.log('‚úÖ Fallback Telegram script loaded')
          resolve()
        }
        script.onerror = () => {
          console.error('‚ùå Fallback script also failed')
          reject()
        }
        document.head.appendChild(script)
      })
    }
    
    // Try loading if not available after 500ms
    setTimeout(() => {
      if (!window.Telegram) {
        console.log('üîÑ Telegram not found, trying fallback loading...')
        loadTelegramScript()
      }
    }, 500)
  </script>

  <!-- Initialize Telegram WebApp -->
  <script>
    // Immediate check
    console.log('üîç Initial check - window.Telegram:', window.Telegram)
    
    // Check after script loads
    setTimeout(() => {
      console.log('üîç After timeout - window.Telegram:', window.Telegram)
      
      if (window.Telegram?.WebApp) {
        window.Telegram.WebApp.ready()
        window.Telegram.WebApp.expand()
        console.log('‚úÖ Telegram WebApp initialized successfully')
        console.log('üì± WebApp data:', {
          initData: window.Telegram.WebApp.initData,
          user: window.Telegram.WebApp.initDataUnsafe?.user,
          platform: window.Telegram.WebApp.platform,
          version: window.Telegram.WebApp.version
        })
      } else {
        console.log('‚ùå Telegram WebApp not available')
        console.log('üîç Debug info:', {
          hasTelegram: !!window.Telegram,
          telegramKeys: window.Telegram ? Object.keys(window.Telegram) : 'no telegram',
          userAgent: navigator.userAgent,
          url: window.location.href
        })
      }
    }, 1000)
    
    // Also check on DOMContentLoaded
    window.addEventListener('DOMContentLoaded', () => {
      console.log('üîç DOMContentLoaded - window.Telegram:', window.Telegram)
    })
  </script>
  
  <title>iOS Academy Pro</title>
  <style>
    /* Telegram theme defaults for local development */
    :root {
      --tg-theme-bg-color: #0b0d10;
      --tg-theme-text-color: #e6e7e9;
      --tg-theme-button-color: #3b82f6;
      --tg-theme-button-text-color: #ffffff;
      --tg-theme-link-color: #60a5fa;
      --tg-color-scheme: dark;
      
      /* Design system fallbacks */
      --background: var(--tg-theme-bg-color);
      --foreground: var(--tg-theme-text-color);
      --primary: var(--tg-theme-button-color);
      --accent: var(--tg-theme-link-color);
    }
    
    /* Prevent white flash by applying Telegram theme immediately */
    html { 
      background: var(--tg-theme-bg-color, #000); 
      color-scheme: var(--tg-color-scheme, dark); 
    }
    body { 
      background: inherit; 
      margin: 0;
    }
  </style>
</head>
<body>
  <div id='root'></div>
  <script type='module' src='/src/main.tsx'></script>
</body>
</html>
