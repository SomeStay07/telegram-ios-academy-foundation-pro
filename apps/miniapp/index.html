<!doctype html>
<html lang='ru'>
<head>
  <meta charset='UTF-8'/>
  
  <!-- Comprehensive Viewport Configuration -->
  <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=5.0, minimum-scale=0.5, user-scalable=yes, viewport-fit=cover'/>
  
  <!-- PWA Meta Tags -->
  <meta name='mobile-web-app-capable' content='yes'/>
  <meta name='apple-mobile-web-app-capable' content='yes'/>
  <meta name='apple-mobile-web-app-status-bar-style' content='black-translucent'/>
  <meta name='theme-color' content='#000000'/>
  <meta name='msapplication-navbutton-color' content='#000000'/>
  
  <!-- Telegram WebApp Meta -->
  <meta name='telegram-web-app' content='1'/>
  
  <!-- Telegram WebApp API Script - CRITICAL for WebApp functionality -->
  <script src="https://telegram.org/js/telegram-web-app.js?59" async></script>
  
  <!-- Alternative Telegram Script Loading -->
  <script>
    // Immediate check and load if needed
    (function() {
      console.log('üöÄ Immediate Telegram script check...');
      
      // Try multiple loading strategies
      let scriptLoaded = false;
      let attempts = 0;
      const maxAttempts = 3;
      
      function checkAndLoadTelegram() {
        attempts++;
        console.log(`üìä Attempt ${attempts}: Checking Telegram availability...`);
        
        if (window.Telegram && window.Telegram.WebApp) {
          console.log('‚úÖ Telegram WebApp found!');
          scriptLoaded = true;
          return true;
        }
        
        if (attempts >= maxAttempts) {
          console.error('‚ùå Max attempts reached, Telegram not available');
          return false;
        }
        
        // Try loading with different URLs
        const urls = [
          'https://telegram.org/js/telegram-web-app.js',
          'https://telegram.org/js/telegram-web-app.js?60',
          'https://telegram.org/js/telegram-web-app.js?latest'
        ];
        
        const url = urls[attempts - 1];
        if (url) {
          console.log(`üîÑ Loading Telegram script from: ${url}`);
          const script = document.createElement('script');
          script.src = url;
          script.async = false; // Load synchronously
          script.onload = function() {
            console.log(`‚úÖ Script loaded from ${url}`);
            setTimeout(checkAndLoadTelegram, 100);
          };
          script.onerror = function() {
            console.log(`‚ùå Failed to load from ${url}`);
            setTimeout(checkAndLoadTelegram, 100);
          };
          document.head.appendChild(script);
        }
        
        return false;
      }
      
      // Start checking immediately
      setTimeout(checkAndLoadTelegram, 0);
    })();
  </script>
  
  <!-- Telegram Script Loading Verification and Fallback -->
  <script>
    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üîç Checking Telegram script loading...');
      
      // Check if Telegram object exists
      if (window.Telegram && window.Telegram.WebApp) {
        console.log('‚úÖ Telegram WebApp API loaded successfully');
        console.log('üìä WebApp object:', window.Telegram.WebApp);
        console.log('üë§ Init data unsafe:', window.Telegram.WebApp.initDataUnsafe);
        
        // Initialize WebApp if available
        if (typeof window.Telegram.WebApp.ready === 'function') {
          window.Telegram.WebApp.ready();
          console.log('‚úÖ WebApp.ready() called');
        }
        if (typeof window.Telegram.WebApp.expand === 'function') {
          window.Telegram.WebApp.expand();
          console.log('‚úÖ WebApp.expand() called');
        }
      } else {
        console.error('‚ùå Telegram WebApp API not loaded!');
        console.log('üîç Window.Telegram:', window.Telegram);
        console.log('üîç Checking script tags...');
        
        const scripts = document.querySelectorAll('script[src*="telegram"]');
        console.log('üìú Telegram scripts found:', scripts.length);
        scripts.forEach((script, index) => {
          console.log(`Script ${index + 1}:`, script.src, 'loaded:', script.readyState);
        });
        
        // Try to load script manually as fallback
        console.log('üîÑ Attempting manual script load...');
        const fallbackScript = document.createElement('script');
        fallbackScript.src = 'https://telegram.org/js/telegram-web-app.js?60';
        fallbackScript.onload = function() {
          console.log('‚úÖ Fallback script loaded');
          if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
          }
        };
        fallbackScript.onerror = function() {
          console.error('‚ùå Fallback script failed to load');
        };
        document.head.appendChild(fallbackScript);
      }
    });
  </script>
  
  <!-- Enhanced Telegram Script Loading with CSP and Network Debugging -->
  <script>
    // Debug environment and CSP
    console.log('üîç Environment Debug:');
    console.log('- User Agent:', navigator.userAgent);
    console.log('- Location:', window.location.href);
    console.log('- Referrer:', document.referrer);
    console.log('- CSP:', document.querySelector('meta[http-equiv="Content-Security-Policy"]')?.content || 'Not set');
    
    // Check if we're actually in Telegram
    const isTelegramEnvironment = navigator.userAgent.includes('Telegram') || 
                                  window.location.search.includes('tgWebApp') ||
                                  document.referrer.includes('telegram') ||
                                  window.parent !== window;
    
    console.log('ü§ñ Telegram Environment Detection:', isTelegramEnvironment);
    
    // Immediate check and load if needed
    (function() {
      console.log('üöÄ Immediate Telegram script check...');
      
      // Check if already available (from sync script)
      if (window.Telegram && window.Telegram.WebApp) {
        console.log('‚úÖ Telegram WebApp already available from sync script!');
        console.log('üìä WebApp version:', window.Telegram.WebApp.version);
        console.log('üìä Platform:', window.Telegram.WebApp.platform);
        console.log('üë§ InitDataUnsafe:', window.Telegram.WebApp.initDataUnsafe);
        
        // Initialize immediately
        if (window.Telegram.WebApp.ready) {
          window.Telegram.WebApp.ready();
          console.log('‚úÖ WebApp.ready() called');
        }
        if (window.Telegram.WebApp.expand) {
          window.Telegram.WebApp.expand();
          console.log('‚úÖ WebApp.expand() called');
        }
        return;
      }
      
      // Try multiple loading strategies with better error handling
      let attempts = 0;
      const maxAttempts = 5;
      
      function checkAndLoadTelegram() {
        attempts++;
        console.log(`üìä Attempt ${attempts}: Checking Telegram availability...`);
        
        if (window.Telegram && window.Telegram.WebApp) {
          console.log('‚úÖ Telegram WebApp found!');
          console.log('üìä WebApp details:', {
            version: window.Telegram.WebApp.version,
            platform: window.Telegram.WebApp.platform,
            initData: window.Telegram.WebApp.initData?.substring(0, 50) + '...',
            user: window.Telegram.WebApp.initDataUnsafe?.user
          });
          
          // Initialize
          if (window.Telegram.WebApp.ready) window.Telegram.WebApp.ready();
          if (window.Telegram.WebApp.expand) window.Telegram.WebApp.expand();
          return true;
        }
        
        if (attempts >= maxAttempts) {
          console.error('‚ùå Max attempts reached, Telegram not available');
          console.log('üîç Final window.Telegram state:', window.Telegram);
          console.log('üîç Script tags check:');
          document.querySelectorAll('script').forEach((script, i) => {
            if (script.src && script.src.includes('telegram')) {
              console.log(`Script ${i}:`, {
                src: script.src,
                readyState: script.readyState,
                loaded: script.onload ? 'has onload' : 'no onload',
                error: script.onerror ? 'has onerror' : 'no onerror'
              });
            }
          });
          return false;
        }
        
        // Try different URLs and methods
        const strategies = [
          { url: 'https://telegram.org/js/telegram-web-app.js', method: 'createElement' },
          { url: 'https://telegram.org/js/telegram-web-app.js?60', method: 'createElement' },
          { url: 'https://telegram.org/js/telegram-web-app.js?latest', method: 'createElement' },
          { url: 'https://telegram.org/js/telegram-web-app.js?61', method: 'innerHTML' },
          { url: 'https://telegram.org/js/telegram-web-app.js?62', method: 'fetch' }
        ];
        
        const strategy = strategies[attempts - 1];
        if (strategy) {
          console.log(`üîÑ Attempt ${attempts}: Loading from ${strategy.url} using ${strategy.method}`);
          
          if (strategy.method === 'createElement') {
            const script = document.createElement('script');
            script.src = strategy.url;
            script.onload = function() {
              console.log(`‚úÖ Script loaded from ${strategy.url}`);
              setTimeout(checkAndLoadTelegram, 200);
            };
            script.onerror = function(error) {
              console.log(`‚ùå Failed to load from ${strategy.url}:`, error);
              setTimeout(checkAndLoadTelegram, 200);
            };
            document.head.appendChild(script);
          } else if (strategy.method === 'innerHTML') {
            console.log('üîÑ Trying innerHTML method...');
            const scriptTag = `<script src="${strategy.url}"><\/script>`;
            document.head.insertAdjacentHTML('beforeend', scriptTag);
            setTimeout(checkAndLoadTelegram, 500);
          } else if (strategy.method === 'fetch') {
            console.log('üîÑ Trying fetch method...');
            fetch(strategy.url)
              .then(response => response.text())
              .then(scriptContent => {
                console.log('‚úÖ Script fetched, executing...');
                eval(scriptContent);
                setTimeout(checkAndLoadTelegram, 200);
              })
              .catch(error => {
                console.log('‚ùå Fetch failed:', error);
                setTimeout(checkAndLoadTelegram, 200);
              });
          }
        }
        
        return false;
      }
      
      // Start checking with a small delay to let sync script load
      setTimeout(checkAndLoadTelegram, 100);
    })();
  </script>
  
  <!-- Telegram Script Loading Verification and Fallback -->
  <script>
    // Wait for DOM to be ready
    document.addEventListener('DOMContentLoaded', function() {
      console.log('üîç Checking Telegram script loading...');
      
      // Check if Telegram object exists
      if (window.Telegram && window.Telegram.WebApp) {
        console.log('‚úÖ Telegram WebApp API loaded successfully');
        console.log('üìä WebApp object:', window.Telegram.WebApp);
        console.log('üë§ Init data unsafe:', window.Telegram.WebApp.initDataUnsafe);
        
        // Initialize WebApp if available
        if (typeof window.Telegram.WebApp.ready === 'function') {
          window.Telegram.WebApp.ready();
          console.log('‚úÖ WebApp.ready() called');
        }
        if (typeof window.Telegram.WebApp.expand === 'function') {
          window.Telegram.WebApp.expand();
          console.log('‚úÖ WebApp.expand() called');
        }
      } else {
        console.error('‚ùå Telegram WebApp API not loaded!');
        console.log('üîç Window.Telegram:', window.Telegram);
        console.log('üîç Checking script tags...');
        
        const scripts = document.querySelectorAll('script[src*="telegram"]');
        console.log('üìú Telegram scripts found:', scripts.length);
        scripts.forEach((script, index) => {
          console.log(`Script ${index + 1}:`, script.src, 'loaded:', script.readyState);
        });
        
        // Try to load script manually as fallback
        console.log('üîÑ Attempting manual script load...');
        const fallbackScript = document.createElement('script');
        fallbackScript.src = 'https://telegram.org/js/telegram-web-app.js?60';
        fallbackScript.onload = function() {
          console.log('‚úÖ Fallback script loaded');
          if (window.Telegram && window.Telegram.WebApp) {
            window.Telegram.WebApp.ready();
            window.Telegram.WebApp.expand();
          }
        };
        fallbackScript.onerror = function() {
          console.error('‚ùå Fallback script failed to load');
        };
        document.head.appendChild(fallbackScript);
      }
    });
  </script>
  
  <title>iOS Academy Pro</title>
  <style>
    /* Telegram theme defaults for local development */
    :root {
      --tg-theme-bg-color: #0b0d10;
      --tg-theme-text-color: #e6e7e9;
      --tg-theme-button-color: #3b82f6;
      --tg-theme-button-text-color: #ffffff;
      --tg-theme-link-color: #60a5fa;
      --tg-color-scheme: dark;
      
      /* Design system fallbacks */
      --background: var(--tg-theme-bg-color);
      --foreground: var(--tg-theme-text-color);
      --primary: var(--tg-theme-button-color);
      --accent: var(--tg-theme-link-color);
    }
    
    /* Prevent white flash by applying Telegram theme immediately */
    html { 
      background: var(--tg-theme-bg-color, #000); 
      color-scheme: var(--tg-color-scheme, dark); 
    }
    body { 
      background: inherit; 
      margin: 0;
    }
  </style>
</head>
<body>
  <div id='root'></div>
  <script type='module' src='/src/main.tsx'></script>
</body>
</html>